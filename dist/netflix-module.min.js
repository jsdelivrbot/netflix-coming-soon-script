/*! netflix-coming-soon-script v1.0.0 ~ 2016-06-04 */
define(["exports","jquery","bootstrap"],function(a,b){"use strict";function c(a){NetflixScriptHelper.showDialog("templates/netflix-code.html",[],function(c){s=b(this);var d=s.find("#pastedCode");d.focus();var e=function(){var b=d.val();if(!b)return d.parent(".form-group").addClass("has-error"),void d.focus();try{a(b)}catch(a){console.log(a),alert("Error al leer la lista de películas: "+a)}};d.keypress(function(a){13==a.which&&e()}),s.find("#startScript").click(e)})}function d(a){return JSON.parse(decodeURIComponent(escape(atob(a))))}function e(a){var b=d(a);s.find("#pastedCode").hide(),s.find(".modal-footer").hide(),t=s.find(".modal-body #scriptOutput"),t.show(),u=s.find(".progress-bar"),s.find(".modal-title").html("Ejecutando script..."),f(b)}function f(a){var b=new g(a||[]);r=b.length;for(var c=new h(y),d=function(a){i(b.next(),function(b,c){j(b,c),a()},function(b,c){console.log("Error al procesar la película '"+c.title+"'"),a()})},e=0;e<a.length;e++)c.submit(d);c.then(function(){u.hide(),l(),sessionStorage.setItem("ALREADY_CHECKED_TITLES",JSON.stringify(v))})}function g(a){var b=0;this.next=function(){return this.hasNext()?a[b++]:null},this.hasNext=function(){return b<a.length},this.length=a.length}function h(a){var b,c=[],d=0;this.submit=function(b){return a>d?(d++,b(e)):c.push(b),this};var e=function(){if(d--,c.length>0){var a=c.shift();d++,a(e)}else"function"==typeof b&&0===d&&b()};this.then=function(a){b=a,0===d&&0===c.length&&b()}}function i(a,c,d){return"undefined"!=typeof v[a.id]?void c(v[a.id],a):void b.get({url:"/title/"+a.id,timeout:15e3}).done(function(b,e,f){try{console.log("OK: "+a.title+" ("+a.id+")");var g=k(b,f.getResponseHeader("X-Originating-URL")||"",a);c(g,a)}catch(b){console.error(b),d(b,a)}}).fail(function(b,e){"timeout"===e?(console.log("TIMEOUT: "+a.title+" ("+a.id+")"),i(a,c,d)):d(e,a)})}function j(a,b){z++,u.css("width",z/r*100+"%"),u.text(z+" de "+r),a===w.COMING_SOON?(A.push(b),m("<b>"+b.title+": "+x[a]+"</b>")):a===w.COMING_REALLY_SOON?(B.push(b),m("<b>"+b.title+": "+x[a].toUpperCase()+"</b>")):m(a===w.NOT_AVAILABLE?'<s style="color: lightgray;">'+b.title+": "+x[a]+"</s>":'<span style="color: gray;">'+b.title+": "+x[a]+"</span>"),v[b.id]=a}function k(a,b,c){var d,e=(new DOMParser).parseFromString(a,"text/html"),f=-1===b.indexOf("/browse"),g=f&&!e.querySelector(".playRing");if(g&&e.querySelector("div.title")){var h=e.querySelector("div.title").textContent,i="SHOW"===h||"MOVIE"===h;d=!i,i||(c.title=h)}var j=w.NOT_AVAILABLE;return d?j=w.COMING_REALLY_SOON:g?j=w.COMING_SOON:f&&(j=w.ALREADY_AVAILABLE),j}function l(){s.find(".modal-title").html("Resultado"),A.length||B.length?t.slideUp("slow",function(){t.html(""),p(A,B),n(A,B),t.fadeIn()}):t.slideUp("slow",function(){t.html(""),m('<div style="text-align: center;"><h3>No he encontrado nada que<br>se vaya a estrenar próximamente...</h3> <h1>:(</h1></div>'),t.fadeIn()})}function m(a){t.append(a+"<br>")}function n(a,b){var c='<h3>Compartir</h3><textarea id="bbcode-area" class="form-control" style="resize: none;" cols=85 rows=10>';a.length&&(c+="\n[SIZE=4][b]Disponibles en un futuro:[/b][/SIZE]\n\n",c+=o(a)+"\n"),b.length&&(c+="\n[SIZE=4][b]Disponibles pronto:[/b][/SIZE]\n\n",c+=o(b)+"\n"),c+="</textarea>",document.queryCommandSupported&&document.queryCommandSupported("copy")&&(c+="<button class=\"btn btn-success\" style=\"width: 100%; margin-top: 5px;\" onclick=\"document.querySelector('#bbcode-area').select(); document.execCommand('copy'); document.querySelector('#bbcode-area').focus();\">Copiar BBCode</button>"),m(c)}function o(a){var b="";return a.forEach(function(a){b+='[url="http://unogs.com/video/?v='+a.id+'"][img]'+a.thumb+'[/img][/url]\n[url="http://www.netflix.com/title/'+a.id+'"][b]'+a.title+"[/b][/url]\n\n"}),b}function p(a,b){a.length&&m("<h2>Disponibles en un futuro</h2>"+q(a)),b.length&&m("<h2>Disponibles pronto</h2>"+q(b))}function q(a){var b="";return a.forEach(function(a){b+='<div class="movie" style="display: inline-block; margin: 5px;" title="'+a.title+'" alt="'+a.title+'"><a href="http://unogs.com/video/?v='+a.id+'"><img class="movie-thumb" style="max-width: 100px;" src="'+a.thumb+'"></img></a><br><a href="http://www.netflix.com/title/'+a.id+'"><b class="movie-title" style="color: gray; display: inline-block; font-size: 12px; overflow: hidden; text-align: center; text-overflow: ellipsis; white-space: nowrap; width: 100px;">'+a.title+"</b></a></div>"}),b}var r,s,t,u,v=JSON.parse(sessionStorage.getItem("ALREADY_CHECKED_TITLES"))||{},w={NOT_AVAILABLE:0,COMING_SOON:1,COMING_REALLY_SOON:2,ALREADY_AVAILABLE:3},x=["No disponible","Disponible en un futuro","Disponible pronto","Ya disponible"],y=4,z=0,A=[],B=[];a.load=function(){c(e)}});